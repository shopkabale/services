<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community Chat | KabaleOnline</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        :root {
            --bg-primary: #0d2857; --bg-secondary: #10336d; --text-primary: #ffffff;
            --text-secondary: #a7c0e8; --accent-primary: #007bff; --border-color: #1f4287;
            --font-family: 'Poppins', sans-serif;
        }
        body.light-mode {
            --bg-primary: #f0f4f9; --bg-secondary: #ffffff; --text-primary: #0d2857;
            --text-secondary: #6c757d; --border-color: #e9ecef;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; }
        body {
            font-family: var(--font-family);
            background-color: var(--bg-primary);
            color: var(--text-secondary);
            display: flex;
            flex-direction: column;
        }
        .header {
            background-color: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-shrink: 0;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 100;
        }
        .back-button {
            background: none; border: none; font-size: 1.5rem;
            color: var(--text-primary); cursor: pointer;
        }
        .header-title { font-size: 1.2rem; font-weight: 600; color: var(--text-primary); }

        .message-area {
            flex-grow: 1;
            overflow-y: auto;
            padding: 95px 15px 20px;
        }
        .message {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            max-width: 85%;
        }
        .message-avatar {
            width: 40px; height: 40px; border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
        }
        .message-content { display: flex; flex-direction: column; }
        .message-sender { font-weight: 600; color: var(--text-primary); font-size: 0.9rem; margin-bottom: 3px; }
        .message-bubble { padding: 10px 15px; border-radius: 18px; line-height: 1.5; background-color: var(--bg-secondary); }
        
        .message.own-message { margin-left: auto; flex-direction: row-reverse; }
        .message.own-message .message-bubble { background-color: var(--accent-primary); color: #fff; }
        .message.own-message .message-sender { display: none; }

        .chat-input-area {
            background-color: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            padding: 15px;
            display: flex;
            gap: 15px;
            flex-shrink: 0;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
        }
        .chat-input {
            flex-grow: 1; padding: 12px 18px;
            background-color: var(--bg-primary); border: 1px solid var(--border-color);
            border-radius: 50px; color: var(--text-primary); font-size: 1rem;
        }
        .chat-input:focus { outline: none; border-color: var(--accent-primary); }
        .btn-send {
            background-color: var(--accent-primary); color: #fff;
            border: none; border-radius: 50%; width: 50px; height: 50px;
            font-size: 1.2rem; cursor: pointer; flex-shrink: 0;
        }
    </style>
</head>
<body class="dark-mode">

    <header class="header">
        <a href="dashboard.html" class="back-button" id="back-button" aria-label="Back to Dashboard">
            <i class="fas fa-arrow-left"></i>
        </a>
        <h1 class="header-title">Community Chat</h1>
    </header>

    <main class="message-area" id="message-area">
        <!-- Messages will be loaded here -->
    </main>

    <footer class="chat-input-area">
        <form id="chat-form" style="display: flex; flex-grow: 1; gap: 15px;">
            <input type="text" class="chat-input" id="message-input" placeholder="Type a message..." autocomplete="off" required>
            <button type="submit" class="btn-send" aria-label="Send Message"><i class="fas fa-paper-plane"></i></button>
        </form>
    </footer>

    <!-- All JavaScript logic is now inside this single script block -->
    <script type="module">
        // --- IMPORT ALL NECESSARY FIREBASE FUNCTIONS ---
        import { app } from './firebase-init.js';
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            query, 
            orderBy, 
            onSnapshot, 
            addDoc, 
            serverTimestamp,
            doc,
            getDoc,
            limit
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // --- INITIALIZE SERVICES ---
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- GET HTML ELEMENTS ---
        const messageArea = document.getElementById('message-area');
        const chatForm = document.getElementById('chat-form');
        const messageInput = document.getElementById('message-input');
        const backButton = document.getElementById('back-button');

        // --- GLOBAL VARIABLES ---
        let currentUser = null;
        let unsubscribe = null; 

        // --- AUTHENTICATION ---
        // This runs as soon as the page loads.
        onAuthStateChanged(auth, async (user) => {
            if (user && user.emailVerified) {
                // User is logged in, now get their profile from Firestore
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists()) {
                    currentUser = {
                        uid: user.uid,
                        name: userDoc.data().name,
                        profilePicUrl: userDoc.data().profilePicUrl
                    };
                    // Set the back button link
                    backButton.href = 'dashboard.html';
                    // Start listening for messages
                    listenForMessages();
                } else {
                     // If profile doesn't exist, something is wrong, send them to login
                     window.location.href = 'auth.html';
                }
            } else {
                // If user is not logged in or not verified, send them to login
                window.location.href = 'auth.html';
            }
        });

        // --- REAL-TIME MESSAGE LISTENER ---
        function listenForMessages() {
            const messagesRef = collection(db, "group-chat");
            const q = query(messagesRef, orderBy("createdAt", "asc"), limit(100));

            unsubscribe = onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added") {
                        renderMessage(change.doc.data());
                    }
                });
                
                // Scroll to the bottom to show the newest message
                setTimeout(() => {
                    messageArea.scrollTop = messageArea.scrollHeight;
                }, 100);
                    
            }, (error) => {
                console.error("Error fetching messages:", error);
                messageArea.innerHTML = `<p style="padding: 20px; text-align: center;">Error: Could not load messages.</p>`;
            });
        }

        // --- RENDER A SINGLE MESSAGE ---
        function renderMessage(data) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';

            if (data.userId === currentUser.uid) {
                messageDiv.classList.add('own-message');
            }

            const avatar = data.profilePicUrl || `https://placehold.co/45x45/10336d/a7c0e8?text=${(data.userName || 'U').charAt(0)}`;

            messageDiv.innerHTML = `
                <img src="${avatar}" alt="${data.userName}" class="message-avatar">
                <div class="message-content">
                    <div class="message-sender">${data.userName}</div>
                    <p class="message-bubble">${data.text}</p>
                </div>
            `;
            messageArea.appendChild(messageDiv);
        }

        // --- HANDLE SENDING A MESSAGE ---
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const messageText = messageInput.value.trim();

            if (messageText && currentUser) {
                try {
                    await addDoc(collection(db, "group-chat"), {
                        text: messageText,
                        userId: currentUser.uid,
                        userName: currentUser.name,
                        profilePicUrl: currentUser.profilePicUrl || '',
                        createdAt: serverTimestamp()
                    });
                    messageInput.value = '';
                } catch (error) {
                    console.error("Error sending message: ", error);
                    alert("Message could not be sent.");
                }
            }
        });

        // Clean up the real-time listener when the user leaves the page
        window.addEventListener('beforeunload', () => {
            if (unsubscribe) {
                unsubscribe();
            }
        });
    </script>
</body>
</html>